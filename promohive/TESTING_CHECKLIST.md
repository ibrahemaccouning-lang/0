# قائمة اختبار الإصلاحات - PromoHive

## قبل البدء

### 1. تطبيق التغييرات على قاعدة البيانات
- [ ] افتح Supabase Dashboard
- [ ] اذهب إلى SQL Editor
- [ ] انسخ محتوى `supabase/migrations/20241031_fix_admin_approval_issues.sql`
- [ ] نفذ الاستعلامات في SQL Editor
- [ ] تحقق من عدم وجود أخطاء

### 2. التحقق من Environment Variables
- [ ] `SMTP_HOST` محدد
- [ ] `SMTP_PORT` محدد
- [ ] `SMTP_USER` محدد
- [ ] `SMTP_PASS` محدد
- [ ] `SMTP_FROM` محدد

### 3. التحقق من Edge Functions
- [ ] `send-notification-email` منشورة
- [ ] اختبر Edge Function من Supabase Dashboard

## اختبارات الوظائف

### اختبار 1: تسجيل مستخدم جديد

**الخطوات:**
1. افتح صفحة التسجيل
2. أدخل بيانات مستخدم جديد:
   - الاسم الكامل
   - البريد الإلكتروني
   - كلمة المرور
3. اضغط على "إنشاء حساب"

**النتائج المتوقعة:**
- [ ] يتم إنشاء الحساب بنجاح
- [ ] تظهر رسالة "Registration Successful!"
- [ ] تظهر رسالة "Awaiting Admin Approval"
- [ ] يتم توجيه المستخدم إلى صفحة الانتظار

**التحقق من قاعدة البيانات:**
```sql
-- تحقق من إنشاء المستخدم
SELECT id, email, full_name, approval_status, status 
FROM user_profiles 
WHERE email = 'test@example.com';

-- يجب أن تكون النتيجة:
-- approval_status: 'pending'
-- status: 'pending'
```

### اختبار 2: ظهور المستخدم الجديد في لوحة الأدمن

**الخطوات:**
1. سجل دخول كأدمن
2. اذهب إلى صفحة "Users Management"
3. تحقق من قائمة المستخدمين

**النتائج المتوقعة:**
- [ ] المستخدم الجديد يظهر في القائمة
- [ ] حالة المستخدم "pending"
- [ ] يظهر زر "Approve" بجانب المستخدم
- [ ] الإحصائيات تعرض عدد المستخدمين المعلقين بشكل صحيح

### اختبار 3: فلترة المستخدمين المعلقين

**الخطوات:**
1. في صفحة "Users Management"
2. اختر فلتر "Status: Pending"

**النتائج المتوقعة:**
- [ ] تظهر فقط المستخدمين المعلقين
- [ ] العدد في الإحصائيات يطابق عدد المستخدمين المعروضين

### اختبار 4: موافقة الأدمن على مستخدم

**الخطوات:**
1. في صفحة "Users Management"
2. اختر مستخدم معلق
3. اضغط على زر "Approve"
4. انتظر رسالة التأكيد

**النتائج المتوقعة:**
- [ ] تظهر رسالة "User approved successfully"
- [ ] يتم تحديث حالة المستخدم إلى "approved"
- [ ] يتم إضافة $5 إلى رصيد المستخدم
- [ ] يتم إرسال بريد إلكتروني ترحيبي للمستخدم
- [ ] تتحدث الإحصائيات تلقائياً

**التحقق من قاعدة البيانات:**
```sql
-- تحقق من تحديث المستخدم
SELECT id, email, approval_status, status, approved_at, approved_by
FROM user_profiles 
WHERE email = 'test@example.com';

-- يجب أن تكون النتيجة:
-- approval_status: 'approved'
-- status: 'active'
-- approved_at: (timestamp)
-- approved_by: (admin_id)

-- تحقق من إضافة البونص
SELECT * FROM transactions 
WHERE user_id = (SELECT id FROM user_profiles WHERE email = 'test@example.com')
AND type = 'bonus';

-- يجب أن يكون هناك transaction بقيمة 5.00

-- تحقق من تحديث المحفظة
SELECT available_balance FROM wallets 
WHERE user_id = (SELECT id FROM user_profiles WHERE email = 'test@example.com');

-- يجب أن يكون الرصيد 5.00
```

### اختبار 5: استلام البريد الإلكتروني

**الخطوات:**
1. بعد موافقة الأدمن
2. تحقق من صندوق البريد الوارد للمستخدم

**النتائج المتوقعة:**
- [ ] يصل بريد إلكتروني ترحيبي
- [ ] البريد يحتوي على اسم المستخدم
- [ ] البريد يذكر البونص $5
- [ ] البريد يحتوي على رابط تسجيل الدخول
- [ ] البريد يحتوي على معلومات الاتصال

**إذا لم يصل البريد:**
1. تحقق من Supabase Edge Function logs
2. تحقق من SMTP settings
3. تحقق من console logs في المتصفح

### اختبار 6: رفض مستخدم

**الخطوات:**
1. في صفحة "Users Management"
2. اختر مستخدم معلق
3. اضغط على زر "Reject" أو "Suspend"
4. أدخل سبب الرفض
5. انتظر رسالة التأكيد

**النتائج المتوقعة:**
- [ ] تظهر رسالة "User rejected/suspended successfully"
- [ ] يتم تحديث حالة المستخدم إلى "suspended"
- [ ] لا يتم إضافة أي بونص
- [ ] يتم تسجيل السبب في audit_logs

### اختبار 7: تسجيل دخول المستخدم المعتمد

**الخطوات:**
1. افتح صفحة تسجيل الدخول
2. أدخل بيانات المستخدم المعتمد
3. اضغط على "Sign In"

**النتائج المتوقعة:**
- [ ] يتم تسجيل الدخول بنجاح
- [ ] يتم توجيه المستخدم إلى لوحة التحكم
- [ ] يظهر رصيد $5 في المحفظة

### اختبار 8: محاولة تسجيل دخول مستخدم معلق

**الخطوات:**
1. افتح صفحة تسجيل الدخول
2. أدخل بيانات مستخدم معلق (لم يتم الموافقة عليه)
3. اضغط على "Sign In"

**النتائج المتوقعة:**
- [ ] يتم تسجيل الدخول تقنياً (Supabase Auth)
- [ ] يتم توجيه المستخدم إلى صفحة انتظار الموافقة
- [ ] لا يمكن الوصول إلى لوحة التحكم

### اختبار 9: إحصائيات لوحة تحكم الأدمن

**الخطوات:**
1. سجل دخول كأدمن
2. اذهب إلى "Admin Dashboard"
3. تحقق من الإحصائيات

**النتائج المتوقعة:**
- [ ] "Total Users" يعرض العدد الصحيح
- [ ] "Pending Approvals" يعرض عدد المستخدمين المعلقين
- [ ] "Active Tasks" يعرض عدد المهام النشطة
- [ ] الإحصائيات تتحدث عند تحديث البيانات

### اختبار 10: Audit Logs

**الخطوات:**
1. بعد إجراء عمليات الموافقة/الرفض
2. تحقق من جدول audit_logs

**التحقق من قاعدة البيانات:**
```sql
-- تحقق من تسجيل العمليات
SELECT * FROM audit_logs 
ORDER BY created_at DESC 
LIMIT 10;

-- يجب أن تظهر:
-- - user_registration
-- - approve_user
-- - reject_user (إذا تم رفض مستخدم)
```

## اختبارات الأداء

### اختبار 11: سرعة تحميل قائمة المستخدمين

**الخطوات:**
1. افتح صفحة "Users Management"
2. قس وقت التحميل

**النتائج المتوقعة:**
- [ ] تحميل القائمة في أقل من 2 ثانية
- [ ] لا توجد أخطاء في console

### اختبار 12: فلترة وبحث

**الخطوات:**
1. في صفحة "Users Management"
2. جرب البحث بالاسم
3. جرب البحث بالبريد الإلكتروني
4. جرب الفلترة حسب الحالة

**النتائج المتوقعة:**
- [ ] البحث يعمل بشكل صحيح
- [ ] الفلترة تعمل بشكل صحيح
- [ ] النتائج تظهر فوراً

## اختبارات الأمان

### اختبار 13: صلاحيات الأدمن

**الخطوات:**
1. حاول الوصول إلى صفحة الأدمن كمستخدم عادي
2. حاول استدعاء دوال الأدمن من console

**النتائج المتوقعة:**
- [ ] المستخدم العادي لا يمكنه الوصول إلى صفحات الأدمن
- [ ] دوال الأدمن ترفض الطلبات من غير الأدمن
- [ ] تظهر رسائل خطأ مناسبة

### اختبار 14: RLS Policies

**التحقق من قاعدة البيانات:**
```sql
-- تحقق من RLS policies
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual 
FROM pg_policies 
WHERE tablename IN ('user_profiles', 'transactions', 'wallets');

-- تأكد من أن:
-- - الأدمن يمكنه SELECT/UPDATE/INSERT على جميع الجداول
-- - المستخدم العادي يمكنه فقط SELECT بياناته الخاصة
```

## تقرير الاختبار

### ملخص النتائج

| الاختبار | النتيجة | ملاحظات |
|---------|---------|---------|
| تسجيل مستخدم جديد | ✅ / ❌ | |
| ظهور في لوحة الأدمن | ✅ / ❌ | |
| فلترة المستخدمين | ✅ / ❌ | |
| موافقة الأدمن | ✅ / ❌ | |
| استلام البريد | ✅ / ❌ | |
| رفض مستخدم | ✅ / ❌ | |
| تسجيل دخول معتمد | ✅ / ❌ | |
| تسجيل دخول معلق | ✅ / ❌ | |
| إحصائيات الأدمن | ✅ / ❌ | |
| Audit Logs | ✅ / ❌ | |
| سرعة التحميل | ✅ / ❌ | |
| البحث والفلترة | ✅ / ❌ | |
| صلاحيات الأدمن | ✅ / ❌ | |
| RLS Policies | ✅ / ❌ | |

### المشاكل المكتشفة

1. 
2. 
3. 

### التوصيات

1. 
2. 
3. 
